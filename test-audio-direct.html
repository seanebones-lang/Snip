<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snip Audio Test - Direct</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .status {
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-size: 16px;
            font-weight: 600;
        }
        .status.pending {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffc107;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 10px 5px;
            transition: all 0.3s;
        }
        button:hover:not(:disabled) {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 6px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        .log-entry {
            margin: 8px 0;
            padding: 8px;
            border-left: 3px solid #007bff;
            padding-left: 12px;
        }
        .log-entry.success {
            border-left-color: #28a745;
            color: #90ee90;
        }
        .log-entry.error {
            border-left-color: #dc3545;
            color: #ff6b6b;
        }
        .log-entry.warning {
            border-left-color: #ffc107;
            color: #ffd700;
        }
        .audio-info {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 6px;
            margin: 15px 0;
            border: 2px solid #007bff;
        }
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ Snip Chatbot - Live Audio Test</h1>

        <div class="test-section">
            <h3>Client Information</h3>
            <p><strong>Client ID:</strong> <span id="clientId">Creating...</span></p>
            <p><strong>API URL:</strong> https://snip-production.up.railway.app</p>
        </div>

        <div class="test-section">
            <h3>Test Controls</h3>
            <button onclick="runFullTest()" id="testBtn">
                üöÄ Run Full Audio Test
            </button>
            <button onclick="clearLog()">Clear Log</button>
            <div id="status" class="status pending">
                ‚è≥ Ready to test. Click "Run Full Audio Test" to begin.
            </div>
        </div>

        <div class="test-section">
            <h3>Audio Information</h3>
            <div id="audioInfo" class="audio-info">
                No audio received yet. Run the test to see audio details.
            </div>
        </div>

        <div class="test-section">
            <h3>Live Test Log</h3>
            <div class="log" id="log"></div>
        </div>
    </div>

    <script>
        let clientId = null;
        let audioReceived = false;
        let audioElement = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            
            const prefix = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            entry.textContent = `[${timestamp}] ${prefix} ${message}`;
            
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type}]`, message);
        }

        function updateStatus(message, type = 'pending') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
        }

        function updateAudioInfo(info) {
            const audioInfoDiv = document.getElementById('audioInfo');
            audioInfoDiv.innerHTML = info;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('Log cleared', 'info');
        }

        // Create test client
        async function createClient() {
            log('Creating test client...', 'info');
            try {
                const response = await fetch('https://snip-production.up.railway.app/api/clients', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: `test${Date.now()}@example.com`,
                        company_name: 'Audio Test Company'
                    })
                });

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`Failed to create client: ${response.status} - ${text}`);
                }

                const clientData = await response.json();
                clientId = clientData.id;
                document.getElementById('clientId').textContent = clientId;
                log(`Client created successfully: ${clientId}`, 'success');
                return clientId;
            } catch (error) {
                log(`Error creating client: ${error.message}`, 'error');
                throw error;
            }
        }

        // Run full audio test
        async function runFullTest() {
            document.getElementById('testBtn').disabled = true;
            audioReceived = false;
            audioElement = null;

            updateStatus('<span class="spinner"></span> Running test...', 'pending');
            log('=== Starting Full Audio Test ===', 'info');

            try {
                // Step 1: Create client
                if (!clientId) {
                    await createClient();
                }

                // Step 2: Send chat message and wait for audio
                log('Sending chat message...', 'info');
                updateStatus('‚è≥ Sending message and waiting for audio response...', 'pending');

                const startTime = Date.now();
                const response = await fetch('https://snip-production.up.railway.app/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        client_id: clientId,
                        message: 'Hello! Please respond with audio. Say "This is a test of the audio system. Can you hear me?"'
                    })
                });

                const responseTime = Date.now() - startTime;

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`Chat failed: ${response.status} - ${text}`);
                }

                const data = await response.json();
                log(`Chat response received in ${responseTime}ms`, 'success');
                log(`Response text: "${data.response}"`, 'info');

                // Step 3: Check for audio
                if (data.audio_url) {
                    audioReceived = true;
                    log('üéµ AUDIO URL RECEIVED!', 'success');
                    
                    // Parse audio URL
                    const audioMatch = data.audio_url.match(/^data:audio\/(\w+);base64,(.+)$/);
                    if (audioMatch) {
                        const format = audioMatch[1];
                        const dataLength = audioMatch[2].length;
                        const estimatedSize = Math.round(dataLength * 0.75); // Base64 is ~33% larger

                        log(`Audio format: ${format.toUpperCase()}`, 'success');
                        log(`Audio data size: ~${estimatedSize} bytes (${Math.round(estimatedSize/1024)} KB)`, 'info');

                        updateAudioInfo(`
                            <strong>‚úÖ Audio Received!</strong><br>
                            Format: ${format.toUpperCase()}<br>
                            Size: ~${Math.round(estimatedSize/1024)} KB<br>
                            Status: Ready to play
                        `);

                        // Step 4: Play audio
                        log('Attempting to play audio...', 'info');
                        updateStatus('üéµ Playing audio now...', 'pending');

                        audioElement = new Audio(data.audio_url);

                        // Set up event listeners
                        audioElement.addEventListener('loadstart', () => {
                            log('Audio loading started', 'info');
                        });

                        audioElement.addEventListener('canplay', () => {
                            log('Audio can play', 'success');
                        });

                        audioElement.addEventListener('playing', () => {
                            log('üéµüéµüéµ AUDIO IS NOW PLAYING! üéµüéµüéµ', 'success');
                            updateStatus('üéµ Audio is playing! Listen now...', 'success');
                        });

                        audioElement.addEventListener('ended', () => {
                            log('‚úÖ Audio playback completed successfully!', 'success');
                            updateStatus('‚úÖ Test completed successfully! Audio played from start to finish.', 'success');
                        });

                        audioElement.addEventListener('error', (e) => {
                            const error = audioElement.error;
                            let errorMsg = 'Unknown error';
                            if (error) {
                                switch(error.code) {
                                    case error.MEDIA_ERR_ABORTED:
                                        errorMsg = 'Playback aborted';
                                        break;
                                    case error.MEDIA_ERR_NETWORK:
                                        errorMsg = 'Network error';
                                        break;
                                    case error.MEDIA_ERR_DECODE:
                                        errorMsg = 'Decode error - audio format may not be supported';
                                        break;
                                    case error.MEDIA_ERR_SRC_NOT_SUPPORTED:
                                        errorMsg = 'Audio source not supported';
                                        break;
                                }
                            }
                            log(`‚ùå Audio playback error: ${errorMsg}`, 'error');
                            updateStatus(`‚ùå Audio playback failed: ${errorMsg}`, 'error');
                        });

                        // Play audio
                        try {
                            await audioElement.play();
                            log('Audio.play() promise resolved', 'success');
                        } catch (playError) {
                            log(`Audio.play() error: ${playError.message}`, 'error');
                            updateStatus(`‚ùå Cannot play audio: ${playError.message}`, 'error');
                        }

                    } else {
                        log(`‚ö†Ô∏è Unexpected audio URL format: ${data.audio_url.substring(0, 50)}...`, 'warning');
                        updateStatus('‚ö†Ô∏è Audio received but format unexpected', 'pending');
                    }
                } else {
                    log('‚ö†Ô∏è No audio_url in response', 'warning');
                    log(`Response keys: ${Object.keys(data).join(', ')}`, 'info');
                    updateStatus('‚ö†Ô∏è No audio received. TTS may require X.AI API key configuration.', 'pending');
                    updateAudioInfo(`
                        <strong>‚ö†Ô∏è No Audio Received</strong><br>
                        TTS requires X.AI API key to be configured via dashboard.<br>
                        Chat response is working correctly.
                    `);
                }

            } catch (error) {
                log(`Error during test: ${error.message}`, 'error');
                updateStatus(`‚ùå Test failed: ${error.message}`, 'error');
            } finally {
                document.getElementById('testBtn').disabled = false;
            }
        }

        // Initialize on load
        window.addEventListener('load', () => {
            log('Test page loaded and ready', 'success');
        });

    </script>
</body>
</html>
